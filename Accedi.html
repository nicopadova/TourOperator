<!DOCTYPE html>
<html>
    <head>
        <title>Accedi</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <!--bootstrap-->
        <link rel="stylesheet" href="./CSS/bootstrap.min.css">
        <!--font-->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
        <style>
            input {
                border: 0;
            }

            .hidden {
                display: none;
            }

            #errore, #errore_pw {
                color: red;
            }
            
            .mancante {
                border-style: solid;
                border-width: 2px;
                border-color: red;
            }

            .invio:hover {
                border-style: solid;
                border-width: 2px;
                border-color: #FBD26C;
                text-decoration: underline;
            }

            /*FOOTER*/
            .footer {
                color: white;
                margin-top: 80px;
                background-color: #366880;
                background-size: 2000px;
                margin-left: 0px !important;
                margin-right: 0px !important;

            }

            .footer img {
                width: 30px;
                height: 30px;
            }

            .footer a {
                color: white;
                text-decoration: none;
                margin-bottom: 70px !important;
            }
        </style>
    </head>
    <body style="font-family: Poppins, sans-serif;">
        <!--HEADER-->
        <nav class="navbar navbar-expand-lg bg-body-tertiar" style="background-color: #f4f4f4;">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img src="IMMAGINI PROGETTO/png-clipart-tour-operator-logo-tours-graphic-design-egipto-paquetes-de-vacaciones-tour-operator-logo.png"
                        alt="Logo" width="200" height="100">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03"
                    aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
    
                <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Chi Siamo
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="./ChiSiamo.html">Chi Siamo</a></li>
                                <li><a class="dropdown-item" href="#">Another action</a></li>
                                <li><a class="dropdown-item" href="#">Something else here</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Destinazioni
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="./destinazioni.html">Tutte le destinazioni</a></li>
                                <li><a class="dropdown-item" href="#">Another action</a></li>
                                <li><a class="dropdown-item" href="#">Something else here</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Alloggi
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="./Alloggi.html">Tutti i nostri alloggi</a></li>
                                <li><a class="dropdown-item" href="#">Another action</a></li>
                                <li><a class="dropdown-item" href="#">Something else here</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Offerte
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="./pacchetti.html">Pacchetti</a></li>
                                <li><a class="dropdown-item" href="./LastMinute.html">Last Minute</a></li>
                                <li><a class="dropdown-item" href="#">Something else here</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Preventivo
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="./Preventivatore.html">Richiedi il tuo preventivo</a></li>
                            </ul>
                        </li>
                        
                    </ul>
                    <div class="dropdown" style="margin-right: 10px;">
                        <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="IMMAGINI PROGETTO/user-profile-icon-free-vector.png" alt="user" width="50"
                                height="50">
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="./Accedi.html">Accedi</a></li>
                            <li><a class="dropdown-item" href="./Registrati.html">Registrati</a></li>
                        </ul>
                    </div>
                    <br>
                    <form class="d-flex" role="search" style="margin-top: 12px;">
                        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                        <button class="btn btn-outline-success" type="submit"
                            style="color: #2e92a9; border-color: #2e92a9; ">Search</button>
                    </form>
    
                </div>
            </div>
        </nav>
        <nav class="shadow border-top pt-1" aria-label="breadcrumb" style="background-color: #f4f4f4;">
            <div class="container-fluid ps-0 ms-0">
                <ol class="breadcrumb ms-2 ps-1 pb-1">
                    <li class="breadcrumb-item"><a href="./Home.html">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Accedi</li>
                </ol>
            </div>
        </nav>
        <!--FINE HEADER-->

        <div class="container my-5 p-3 rounded shadow-lg" style="width: 310px; background-color: #F4F4F4;"> <!--ACCEDI-->
            <div class="row text-center">
                <div class="col-12 mb-2">
                    <img src="./IMMAGINI PROGETTO/png-clipart-tour-operator-logo-tours-graphic-design-egipto-paquetes-de-vacaciones-tour-operator-logo.png" width="60px">
                </div>
                <div class="col-12 my-2">
                    <p>Accedi alla tua Area Privata</p>
                </div>
            </div> <!--FINE RIGA-->
            <div class="row text-center"> <!--FORM-->
                <label class="hidden pb-1" id="errore"><ins>CAMPO MANCANTE!</ins></label>
                <form id="accedi" name="form1" action="" onsubmit="login(event)">
                    <div class="form-floating mx-2 mb-2">
                        <input type="email" class="form-control" name="email" id="email_utente" onclick="resetta()" placeholder="email@example.com">
                        <label for="email_utente">Indirizzo Email</label>
                    </div>
                    <div class="form-floating mx-2 mb-2">
                        <div class="form-floating mx-0 mb-2" style="display: flex; flex-direction: row;">
                            <input type="password" class="form-control" name="password" id="pw_accesso" onclick="resetta()" placeholder="Password" aria-describedby="basic-addon2">
                            <label for="pw_accesso">Password</label>
                            <span class="input-group-text pw-eye" id="basic-addon2" onclick="showHidePW()"><img src="./IMMAGINI PROGETTO/eye.png" class="opacity-50 accesso" height="45px"><img src="./IMMAGINI PROGETTO/hide.png" class="opacity-50 accesso hidden" height="45px"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <p class="text-start mt-1" style="color: grey; font-size: x-small;"><a href="#">informativa per la privacy</a></p>
                            <p class="text-end mt-1" style="color: grey; font-size: x-small;"><a href="#">Password dimenticata?</a></p>
                        </div>
                    </div> <!--FINE DIV-->
                    <input type="submit" class="btn invio" style="background-color: #EF7365; color:#F4F4F4" value="LOGIN">
                </form>
            </div>
        </div> <!--FINE ACCEDI-->
        <div class="container my-5 p-3 rounded shadow-lg" style="width:310px"> <!--REGISTRATI-->
            <div class="row text-center">
                <div class="col-12">
                    <p>Non sei ancora registrato?</p>
                </div>
                <div class="col-12">
                    <a class="btn invio" href="./Registrati.html" role="button" style="background-color: #EF7365; color: #F4F4F4;">Registrati ora</a>
                </div>
            </div> <!--FINE RIGA-->
        </div> <!--FINE REGISTRATI-->
        <!--JS BOOTSTRAP-->
        <script src="./JS/bootstrap.bundle.min.js"></script>
        <!--JS-->
        <script>
            const errore = document.getElementById('errore');
            function resetta() {
                const mancanti = document.getElementsByClassName("mancante");
                for (let dato of mancanti) {
                    dato.classList.remove("mancante");
                }
                //nascondo nuovamente il messaggio di errore campo mancante
                if(!errore.classList.contains('hidden')) {
                    errore.classList.add('hidden');
                }
            }
            function showHidePW() {
                //prendo le icone da cambiare
                let icona = document.getElementsByClassName('accesso');
                let password = document.getElementById('pw_accesso');;
                if (password.type =='password') {
                    password.type='text';
                } else {
                    password.type='password';
                }
                for (let img of icona) {
                    img.classList.toggle('hidden');
                }
            }
            
            async function login(event) {
                event.preventDefault();
                const email = document.getElementById('email_utente');
                const password = document.getElementById('pw_accesso');
                let incompleto = false;
                if (email.value=="") {
                    email.classList.add("mancante");
                    incompleto=true;
                };
                if (password.value=="") {
                    password.classList.add("mancante");
                    incompleto=true;
                }
                if (incompleto) {
                    if(errore.classList.contains('hidden')) {
                        errore.classList.remove('hidden');
                    }
                }
                const richiesta = {
                    email: email.value,
                    password: password.value
                }
                
                try {
                    const response = await fetch('http://localhost:8080/auth/login', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(richiesta)
                    });

                    if (response.status === 200) {
                        const data = await response.json();
                        const token = data.token;
                        localStorage.setItem('authToken', token);
                        username = email.value;
                        redirect(username);
                    } else {
                        console.log('login 1 errore');
                        //error
                    }
                } catch (error) {
                    console.log('login 2 errore');
                    //messaggio di errore
                }
            };

            async function logout(event) {
                event.preventDefault();
                const token = localStorage('authToken');

                try {
                    const response = await fetch('http://localhost:8080/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `${token}`
                        }
                    });

                    if(response.status === 200) {
                        localStorage.removeItem('authToken');
                        console.log('logout ok')
                    } else {
                        console.log('logout 1 errore');
                    }
                }catch(erorr) {
                    console.log('logout 2 errore');
                }
            };
            
            function redirect(email) {
                fetch(`http://localhost:8080/utenti/searchByEmail?email=${email}`)
                    .then(res => res.json())
                    .then(data => {
                        if(data.ruolo=='USER') {
                            console.log('ok USER')
                            window.location.href='./PaginaPersonale.html';
                        } else if (data.ruolo=='ADMIN') {
                            window.location.href='./admin.html';
                        }
                    })
            }
        </script>
    </body>
    <br>
    <footer class="footer w-100" style="font-family: Poppins, sans-serif;  ">
        <br>
        <br>
        <div class="container text-center">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-12 col-12">
                    <h3>La Nostra Azienda</h3>
                    <br>
                    <p>Tour Calypso S.R.L.S</p>
                    <p><strong>Roma</strong> , Via dei Cerchi 17, 00186</p>
                    <p><strong>Partita IVA: </strong>03842567922</p>
    
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12 col-12">
                    <h3>Contatti</h3>
                    <br>
                    <a href="#">
                        <img src="IMMAGINI PROGETTO/icons8-facebook-500.png" alt="Facebook">
                    </a>
    
                    <a href="#">
                        <img src="IMMAGINI PROGETTO/icons8-instagram-500.png" alt="Instagram">
                    </a>
    
                    <a href="#">
                        <img src="IMMAGINI PROGETTO/icons8-twitterx-500.png" alt="Twitter">
                    </a>
    
                    <a href="#">
                        <img src="IMMAGINI PROGETTO/icons8-youtube-logo-500.png" alt="Youtube">
                    </a>
                    <br>
                    <br>
                    <a class="telefono" href="#">
                        <img src="IMMAGINI PROGETTO/telefono.png" alt="telefono">
                        <span> +39 586 718 8296</span>
                    </a>
                    <br>
                    <br>
                    <a class="email" href="#">
                        <img src="IMMAGINI PROGETTO/email.png" alt="email">
                        <span> calypsotour@pec.it</span>
                    </a>
    
    
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12 col-12">
                    <div class="linkbut">
                        <h3>Link Utili</h3>
                        <br>
                        <a href="./Home.html">Home</a>
                        <br>
                        <br>
                        <a href="./ChiSiamo.html">Chi siamo</a>
                        <br>
                        <br>
                        <a href="#">Servizi</a>
                        <br>
                        <br>
                        <a href="#">Contatti</a>
                        <br>
                        <br>
                        <a href="#">Metodi di Pagamento</a>
                        <br>
                        <br>
                        <a href="#">Bagaglio</a>
                        <br>
                        <br>
                        <a href="#">Assicurazioni</a>
                        <br>
                        <br>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-12 col-12">
                    <div class="linkbut">
                        <h3>Calypso World</h3>
                        <br>
                        <a href="#">Lavora con Noi</a>
                        <br>
                        <br>
                        <a href="#">Il Gruppo</a>
                        <br>
                        <br>
                        <a href="./Accedi.html">Area Riservata</a>
                        <br>
                        <br>
                        <a href="#">Convenzioni</a>
                        <br>
                        <br>
                        <a href="#">Escursioni</a>
                        <br>
                        <br>
                        <a href="#">FAQ</a>
                        <br>
                        <br>
                        <a href="#">Guida per gli Utenti</a>
                        <br>
                        <br>
                        <a href="#">Guida per i Gestori</a>
                        <br>
                        <br>
                    </div>
                </div>
    
    
            </div>
        </div>
    </footer>  
</html>